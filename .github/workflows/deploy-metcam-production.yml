name: Deploy Metcam (Production)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_if_busy:
        description: "Skip deployment when preview/recording is active"
        type: boolean
        required: false
        default: true
      no_smoke:
        description: "Skip recording smoke check"
        type: boolean
        required: false
        default: false
      smoke_duration_seconds:
        description: "Recording smoke duration (seconds)"
        required: false
        default: "12"
      skip_frontend:
        description: "Skip web dashboard build/deploy"
        type: boolean
        required: false
        default: false
      force_frontend:
        description: "Force web dashboard build/deploy"
        type: boolean
        required: false
        default: false

concurrency:
  # Do not cancel an in-progress deployment; queue new deploys instead.
  group: metcam-production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: [self-hosted, linux, arm64, metcam]
    timeout-minutes: 40
    steps:
      - name: Preflight (repo + sudo)
        id: preflight
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! -d /home/mislav/footballvision-pro ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=missing_repo_dir" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! sudo -n true; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=sudo_requires_password" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "reason=" >> "$GITHUB_OUTPUT"

      - name: Check Device Busy
        id: busy
        if: steps.preflight.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail

          SKIP_IF_BUSY="${{ github.event.inputs.skip_if_busy || 'true' }}"
          if [[ "$SKIP_IF_BUSY" != "true" ]]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          API="http://localhost:8000/api/v1"
          rec="$(curl -fsS "$API/recording" || true)"
          state="$(curl -fsS "$API/pipeline-state" || true)"

          python3 - <<'PY' "$rec" "$state" "$GITHUB_OUTPUT"
          import json
          import sys

          rec_raw, state_raw, out = sys.argv[1], sys.argv[2], sys.argv[3]
          skip = False
          reasons = []

          try:
              rec = json.loads(rec_raw) if rec_raw else {}
              if rec.get("recording"):
                  skip = True
                  reasons.append("recording_active")
          except Exception:
              pass

          try:
              state = json.loads(state_raw) if state_raw else {}
              mode = state.get("mode")
              if mode and mode != "idle":
                  skip = True
                  reasons.append(f"pipeline_mode={mode}")
          except Exception:
              pass

          with open(out, "a", encoding="utf-8") as handle:
              handle.write(f"skip={'true' if skip else 'false'}\n")
              handle.write(f"reason={','.join(reasons)}\n")
          PY

      - name: Skip Notice
        if: steps.preflight.outputs.skip == 'true' || steps.busy.outputs.skip == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ steps.preflight.outputs.skip }}" == "true" ]]; then
            echo "Skipping deploy: ${{ steps.preflight.outputs.reason }}"
            exit 0
          fi
          echo "Skipping deploy: ${{ steps.busy.outputs.reason }}"

      - name: Deploy (safe + rollback)
        if: steps.preflight.outputs.skip != 'true' && steps.busy.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd /home/mislav/footballvision-pro

          NO_SMOKE="${{ github.event.inputs.no_smoke || 'false' }}"
          SMOKE_DURATION="${{ github.event.inputs.smoke_duration_seconds || '12' }}"
          SKIP_FRONTEND="${{ github.event.inputs.skip_frontend || 'false' }}"
          FORCE_FRONTEND="${{ github.event.inputs.force_frontend || 'false' }}"

          args=()
          if [[ "$NO_SMOKE" == "true" ]]; then
            args+=( --no-smoke )
          else
            args+=( --smoke-duration "$SMOKE_DURATION" )
          fi
          if [[ "$SKIP_FRONTEND" == "true" ]]; then
            args+=( --skip-frontend )
          fi
          if [[ "$FORCE_FRONTEND" == "true" ]]; then
            args+=( --force-frontend )
          fi

          set -o pipefail
          ./deploy/deploy-safe.sh "${args[@]}" 2>&1 | tee /tmp/deploy-safe.log

      - name: Upload Deploy Log
        if: always() && steps.preflight.outputs.skip != 'true' && steps.busy.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deploy-safe-log
          path: /tmp/deploy-safe.log
          if-no-files-found: warn

